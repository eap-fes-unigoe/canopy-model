# Model results


```{r, include=FALSE}
suppressPackageStartupMessages({
  suppressWarnings({
   source('radiative_transfer/term paper/radiation_utils_test_data.R')
   # library(scales)
    library(tsibble)
    library(hydroGOF)
  })
})
```
```{r, include = F, cache = T}
out <- rad_transf_new_p()

out_plot <- tibble(datetime = input$datetime, night = input$night, mod_sw_out = out$i_up, obs_sw_out = fluxes$sw_out, mod_lw_out = out$l_up, obs_lw_out = fluxes$lw_out)
out_all <- cbind(input, select(fluxes, -time, -Date.Time), out)
out_1week <- filter(out_all, datetime > as_date("2018-07-1") & datetime < as_date("2018-07-8"))

out_1year_wk <- out_all %>% # to day average
  select(-c(night, time)) %>%
  as_tsibble(index = datetime) %>%
  index_by(week = ~ yearweek(.)) %>%
  summarise_all(mean, na.rm = TRUE)
```

## Model output


The first aspect to explore is the main model output both for the shortwave and longwave component


### Shortwave

The shown shortwave variables are:

 - Incoming sw (measured) $I^\downarrow$
 - Absorbed sw by canopy $I^\uparrow$
 - Upward sw reflected by the canopy $\overrightarrow{I}_{c}$
 - Absorbed sw soil $\overrightarrow{I}_{g}$

Due to radiative balance those variables are in the following relationship:

$I^\downarrow = I^\uparrow + \overrightarrow{I}_{c} + \overrightarrow{I}_{g}$



#### One week {-}

In figure \@ref(fig:sw-1wk) the model output for the shortwave is plotted for one week during the summer.
The daily cycle can be clearly seen, with all variables having a peak at noon and reach the value of 0 during the night.
The total incoming radiation changes depending on the day, mainly due to cloud cover, and the absorbed shortwave follow its pattern.
```{r sw-1wk, echo = F, fig.cap = "Shortwave one week. Modeled output variables (1-8 Jul 2018)."}
out_1week %>%
        gather(key = "type", value = "radiation", sw_in, ic, i_up, ig, factor_key = T) %>%
        ggplot() +
        night_bg(out_1week) +
        geom_line(aes(x = datetime, y = radiation, color = type)) +
        legend_labels(c("Incoming sw", "Absorbed sw canopy", "Upward sw", "Absorbed sw soil")) +
        labs(x = "Datetime", y = "Shortwave radiation (W m-2)", title = "Shortwave one week", subtitle = "Modeled output variables (1-8 Jul 2018)")
```
#### One year {-}

Then the shortwave over one year is analyzed \@ref(fig:sw-1y), after aggregating over one week.
There is a yearly cycle in the incoming shortwave radiation with a significant difference,
as the averages goes from more than 300 $W m^2$ to almost 10 $W m^2$ (this is the week average so takes into account also the night when there is 0 sw radiation).
During the winter the LAI it is estimated at`1`, as even if there are no leaves the branches still absorbs light.

The absorbed by the soil depends on the amount of LAI, in fact during the spring when the radiation is high but there are no leaves yet its values increase constantly.
As soon as leaves starts to come out the shortwave absorbed by the soil decreases to reach a stable low value during the summer and eventually increase again when leaves fall.

The radiation reflected by the canopy doesn't have a big change over the year and overall canopy albedo remains for the all year between `0.16` and `0.20`.
Finally, the radiation absorbed the canopy follows, as expected, the pattern in the incoming radiation. During the spring its value are really similar to the shortwave absorbed by the soil, however this is only a coincidence in this setting.
```{r sw-1y, echo = F, fig.cap = "Shortwave one year. Modeled output variables, weekly average 2018. Vertical balck lines are the moment when there is change in LAI"}
lai_breaks <- as_datetime(c("2018-04-19", "2018-06-19", "2018-10-7", "2018-10-28"))
lai_breaks_lbl <- c("leaf out", "leaf complete", "leaf fall", "leaf fall complete")
pos <- function (x) {x+10}
out_1year_wk %>%
        gather(key = "type", value = "radiation", , sw_in, ic, i_up, ig, factor_key = T) %>%
        ggplot() +
        geom_vline(xintercept = lai_breaks, linetype=2, alpha = .8, size=.4) +
        annotate('label', x=lai_breaks, y=c(315, 315, 315, 290), label = lai_breaks_lbl) + #make the last lable lower to avoid overlap
        geom_line(aes(x = datetime, y = radiation, color = type)) +
        legend_labels(c("Incoming sw", "Absorbed sw canopy", "Upward sw", "Absorbed sw soil")) +
        labs(x= "Datetime", y = "Shortwave radiation (W m-2)", title="Shortwave one year", subtitle = "Modeled output variables, weekly average 2018")
```

### Longwave

The shown longwave variables are:

 - Incoming lw (measured) $L^\downarrow$
 - Absorbed lw by canopy $L^\uparrow$
 - Upward lw emitted by the canopy $\overrightarrow{L}_{c}$
 - Absorbed lw soil $\overrightarrow{L}_{g}$

Due to radiative balance those variables are in the following relationship:

$L^\downarrow = L^\uparrow + \overrightarrow{L}_{c} + \overrightarrow{L}_{g}$

#### One week {-}

Longwave radiation have a daily cycles, but the variation is much smaller compared to shortwave \@ref(fig:lw-1wk).
The canopy is emitting more longwave radiation than the one that is receiving from the sky, hence the absorbed radiation from the canopy is negative.
The incoming shortwave radiation depends on the weather, with cloudy skies resulting in higher level of incoming radiation as it can be seen on the 5-6 of July. The difference can be quite important with an increse of about 30% in radiation levels.
The upward longwave radiation, instead, depends on the temperature of the canopy and the soil, which is influenced by heat fluxes and shortwave radiation. Therefore the incoming and outgoing radiation doesn't change together and the radiative balance changes, reaching almost zero in the morning of the 6th of July

Need to talk about the different behaviour in soil/canopy trends

```{r lw-1wk, echo = F, fig.cap = ""}
out_1week %>%
        gather(key = "type", value = "radiation", lw_in, l_up, lc, lg, factor_key = T) %>%
        ggplot() +
        geom_hline(yintercept = 0, linetype = 2) +
        night_bg(out_1week) +
        geom_line(aes(x = datetime, y = radiation, color = type)) +
        labs(x = "Datetime", y = "Longwave radiation (w m-2)") +
        legend_labels(c("Incoming lw", "Upward lw", "Absorbed lw canopy", "Absorbed lw soil"))
```


#### One year {-}
During the year there longwave radiation has a cycle with higher values in the summer than in the winter. However the different in limited.

```{r, echo = F}
out_1year_wk %>%
  gather(key = "type", value = "radiation", lw_in, l_up, lc, lg, factor_key = T) %>%
  ggplot() +
  geom_hline(yintercept = 0, linetype=2) +
  geom_line(aes(x = datetime, y = radiation, color = type)) +
  labs(x="Datetime", y = "Longwave radiation (w m-2)") +
  legend_labels(c("Incoming lw", "Upward lw", "Absorbed lw canopy", "Absorbed lw soil"))
```

## Model Evaluation

The model results

### Shortwave

#### Time series {-}
##### One Week {-}

The model has an overall good agreement between the modeled outgoing sw and the measured one

The non-zero values at night are problem of the sensor not the model
```{r swout-1wk, echo = F, fig.cap = "Shortwave one week. Modeled output variables (1-8 Jul 2018)."}
out_1week %>%
        gather(key = "type", value = "radiation", i_up, sw_out, factor_key = T) %>%
        ggplot() +
        night_bg(out_1week) +
        geom_line(aes(x = datetime, y = radiation, color = type)) +
        labs(y = "Outgoing shortwave radiation (w m-2)") +
        legend_labels(labels = c("Modelled", "Observed"), "Outgoing shortwave radiation")
```
##### One Year {-}
Problem in estimating the LAI during the spring/fall the model is less accurate
```{r swout-1yr, echo = F, fig.cap = "Shortwave one week. Modeled output variables (1-8 Jul 2018)."}
out_1year_wk %>%
        gather(key = "type", value = "radiation", i_up, sw_out, factor_key = T) %>%
        ggplot() +
        geom_line(aes(x = datetime, y = radiation, color = type)) +
        labs(y = "Outgoing shortwave radiation (w m-2)") +
        legend_labels(labels = c("Modelled", "Observed"), "Outgoing shortwave radiation")
```

#### Quantitative evaluation {-}

```{r, echo = F}
sw_lm <- lm(obs_sw_out ~ mod_sw_out, data = out_plot)
sw_r2 <- round(summary(sw_lm)$r.squared, 2)
sw_slope <- round(coef(sw_lm)[2], 2)
sw_intercept <- round(coef(sw_lm)[1], 2)
sw_rmse <- sqrt(mean((out_plot$obs_sw_out - out_plot$mod_sw_out)^2))
sw_nse <- NSE(out_plot$mod_sw_out, out_plot$obs_sw_out) # Nash-Sutcliffe Efficiency
```
```{r sw-scat, echo = F}
ggplot(out_plot) +
  geom_abline(aes(intercept = 0, slope = 1, color = "Theory"), key_glyph = "path") +
  geom_point(aes(x = mod_sw_out, y = obs_sw_out)) +
  geom_smooth(aes(x = mod_sw_out, y = obs_sw_out, color = "Regression"), formula = y ~ x, method = 'lm', se = F) +
  labs(title = "Outgoing sw modeled vs observed",
       subtitle = paste(c("slope: ", sw_slope, " intercept: ", sw_intercept, " r2: ", sw_r2, " . Data from 2018."), collapse = ""),
       x = "Modelled outgoing sw (W m-2)", y = "Observed outgoing sw (W m-2)", colour = "Legend")
```


### Longwave

#### Time series {-}
##### One Week {-}

The model has an overall good agreement between the modeled outgoing lw and the measured one

The non-zero values at night are problem of the sensor not the model
```{r lwout-1wk, echo = F, fig.cap = "Shortwave one week. Modeled output variables (1-8 Jul 2018)."}
out_1week %>%
        gather(key = "type", value = "radiation", l_up, lw_out, factor_key = T) %>%
        ggplot() +
        night_bg(out_1week, y_mean = 400) +
        geom_line(aes(x = datetime, y = radiation, color = type)) +
        labs(y = "Outgoing shortwave radiation (w m-2)") +
        legend_labels(labels = c("Modelled", "Observed"), "Outgoing shortwave radiation")
```
##### One Year {-}
Problem in estimating the LAI during the spring/fall the model is less accurate
```{r lwout-1yr, echo = F, fig.cap = "Shortwave one week. Modeled output variables (1-8 Jul 2018)."}
out_1year_wk %>%
        gather(key = "type", value = "radiation", l_up, lw_out, factor_key = T) %>%
        ggplot() +
        geom_line(aes(x = datetime, y = radiation, color = type)) +
        labs(y = "Outgoing shortwave radiation (w m-2)") +
        legend_labels(labels = c("Modelled", "Observed"), "Outgoing shortwave radiation")
```

#### Quantitative evaluation {-}

```{r, echo = F}
lw_lm <- lm(obs_lw_out ~ mod_lw_out, data = out_plot)
lw_r2 <- round(summary(lw_lm)$r.squared, 2)
lw_slope <- round(coef(lw_lm)[2], 2)
lw_intercept <- round(coef(lw_lm)[1], 2)

lw_rmse <- round(sqrt(mean((out_plot$obs_lw_out - out_plot$mod_lw_out)^2)), 2)
lw_nse <- round(NSE(out_plot$mod_lw_out, out_plot$obs_lw_out), 2)# Nash-Sutcliffe Efficiency
```
Linear model
`r lw_slope`

```{r lw-scat, echo = F}
ggplot(out_plot) +
  geom_abline(aes(intercept = 0, slope = 1, color = "Theory"), key_glyph = "path") +
  geom_point(aes(x = mod_lw_out, y = obs_lw_out)) +
  geom_smooth(aes(x = mod_lw_out, y = obs_lw_out, color = "Regression"), formula = y ~ x, method = 'lm', se = F) +
  labs(title = "Outgoing lw modeled vs observed",
       subtitle = paste(c("slope: ", lw_slope, " intercept: ", lw_intercept, " r2: ", lw_r2, " . Data from 2018."), collapse = ""),
       x = "Modeled outgoing lw (W m-2)", y = "Observed outgoing lw (W m-2)", colour = "Legend")
```

RMSE:``r lw_rmse``   NSE:``r lw_nse``
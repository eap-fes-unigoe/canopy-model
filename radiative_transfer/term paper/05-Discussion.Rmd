# Discussion

## Model components

After the analyzing the model results and evaluating its performance a more the behaviour of the model components is analyzed.

### Kb {-}

The direct beam extinction coefficient depends on the leaf angle distribution, which is considered constant and the zenith.
The sun elevation is the most important elements that influences the penetration of direct shortwave radiation.
For zenith inferior to $30°$ the *Kb* has a value of about $0.5$ (Figure \@ref(fig:kb-zenith)),
then reaches $1$ with a $60°$ zenith and eventually start to grow exponentially reaching the theoretical value of infinity when the zun is completely horizontal.
```{r kb-zenith, fig.cap = "Kb over zenith", echo = F}
zenith <- seq(0,85)
Kb <- map_dbl(zenith, get_Kb)

ggplot() +
  geom_line(aes(x = zenith , y = Kb)) +
  labs(title = "Kb over zenith", x="Zenith (degrees)")+
  scale_y_continuous(n.breaks = 7, limits = c(0,NA))
```
### Kd {-}
The diffuse radiation extinction coefficient does not depend on directly on the solar zenith, as the radiation comes from all directions.
The variable it depends on is the LAI.
The bigger the LAI the smaller the Kd, thus more light penetrates through the canopy (Figure \@ref(fig:kd-lai)).
The range of the *Kd* has a smaller than the *Kb*.
The *Kd* showed in this plot is used only by the longwave model, as the 2 stream approximation uses a different *Kd* that depends only on leaf angle distribution.
```{r kd-lai, echo = F}
LAI <- seq(1,10,.25)
Kd <- map_dbl(LAI, get_Kd)

ggplot() +
  geom_line(aes(x = LAI, y = Kd)) +
  labs(title = "Kd over LAI")
```

### Absorbed radiation over LAI {-}

The amount LAI influences directly the amount of radiation absorbed.
The increase in LAI increase the amount of radiation absorbed, but then it reaches a peak at even if the LAI increase no more light is absorbed.

```{r, echo = F}
fake_input_5 <- tibble(
  datetime = as.Date("2020-07-15 12:00"), sw_in = 1000, sw_dif = 100, lw_in = 0, t_soil = 0, t_leaf = 0, zenith = 30,
  LAI = 1:12
)

out_2 <- cbind(rad_transf(input = fake_input_5), sw_in = fake_input_5$sw_in)
labels <- str_wrap(c("Total incoming sw", "Total absorbed sw", "Absorbed sw sunlit canopy", "Absorbed sw shaded canopy"), 10)

out_2 %>%
  gather("type", "radiation", sw_in, ic, ic_sun, ic_sha, factor_key = T) %>%
  ggplot() +
  geom_line(aes(x = LAI, y = radiation, color = type, linetype = type)) +

  labs(title = "Absorbed shortwave with increasing LAI", subtitle = "Incoming radiation 900 direct + 100 diffuse. Zenith 30°",
       x = "LAI (m2 m-2)", y = "Absorbed shortwave radiation (W m-2)", color = "", linetype = "") +
  scale_color_manual(values = c("black", hue_pal()(3)), labels = labels) +
  scale_linetype_manual(values = c(2, 1, 4, 4), labels = labels) +
  theme(legend.key.height = unit(40, "pt"))

```
```{r}
ggplot(out_2) +
geom_line(aes(x=LAI, y=ic_sha/ic))+
labs(title="Fraction of radiation absorbed by shaded leaves over LAI", y="Fraction abosorbed by shaded leaves")
```
Variation of absorbed radiation by the soil and canopy with the variation of LAI

We can see that the overall canopy albedo is constant while the division between soil and canopy changes

```{r, echo = F}
out_2 %>%
  gather("Radiation_type", "Radiation", ic, ig, i_up) %>%
  ggplot() +
  geom_line(aes(x = LAI, y = Radiation, color = Radiation_type, linetype = Radiation_type))
```

## Emitted and Absorbed longwave radiation at different temperature


Soil and leaves temperature changes together between 260 and 310 K

This is so Boring...

```{r, echo = F}
fake_input_3 <- tibble(
  datetime = as.Date("2020-07-15 12:00"), # Summer day
  sw_in = 800,
  sw_dif = 100,
  lw_in = 200,
  t_soil = 260:310,
  t_leaf = 260:310,
  zenith = 30,
)

out_3 <- rad_transf(fake_input_3, fake_input_3) # the second time is for the state

out_3 %>%
  select(-zenith) %>%
  cbind(fake_input_3) %>%
  gather("type", "radiation", lc) %>%
  ggplot() +
  geom_line(aes(x = t_leaf, y = radiation, color = type))
```
```{r}

```

## Absorbed radiation vs zenith


Variation of the fraction of soil radiation that is absorbed with the change of the solar zenith (angle between vertical and sun)

```{r ic-zenith, echo=F}
fake_input_4 <- tibble(
  datetime = as.POSIXct("2016-07-21 00:00"), # Summer day
  zenith = seq(0, 90, 2.5),
  sw_in = 1000,
  sw_dif = 100,
  lw_in = 200,
  t_soil = 300,
  t_leaf = 300,
)
out_4 <- rad_transf(fake_input_4)

out_4 %>%
  select(-zenith) %>%
  cbind(fake_input_4) %>%
  mutate(absorbed_fraction = ic / sw_in) %>%
  ggplot() +
  geom_line(aes(x = zenith, y = absorbed_fraction), color = "red") +
  labs(x = "Zenith (deg)", y = "Fraction of total radiation absorbed", title="Fraction of absorbed radiation with different zenith")
```

```{r}
# time_out %>%
#   ggplot() +
#   geom_line(aes(x = datetime, y = LAI_sunlit)) +
#   geom_hline(yintercept = 5, linetype = "dotted")
# labs(y = "LAI sunlit (m2 m-2)")
```

## Model limits and applications

The model was developed for explorative purposes.



## Model improvements

The model has been implement with the goal to be simple
The future step in order to have a better model are:

 - solving the shortwave radiations for the visible and near infrared radiation, as leaves have different optical properties
 - using more accurate equation than the two-streams approximation, like
 - optimizing the performance of the model in order to allow for faster iteration during the analysis

For the last point an experimental port has been made using the Julia language [https://github.com/eap-fes-unigoe/canopy-model](https://github.com/eap-fes-unigoe/canopy-model)
obtaining promising results (roughly 1000 times faster).



---
title: "Plots for radiative transfer plot"
author: "Simone Massaro"
date: "01/02/21"
output:
  pdf_document: default
  html_document:
    df_print: paged
---
```{r "setup", include=FALSE}
knitr::opts_knit$set(root.dir = "../../")
Sys.setlocale("LC_ALL", "en_US")
```

```{r, message = F}
source('radiative_transfer/notebooks/setup_radiation_test_data.R')
library(scales)
```

```{r}
out <- rad_transf_new_p()

out_plot <- tibble(datetime = input$datetime, model_sw_out = out$i_up, observed_sw_out = fluxes$sw_out, model_lw_out = out$l_up, observed_lw_out = fluxes$lw_out)

time_out <- cbind(input, select(fluxes,-time, -Date.Time), out) %>%
  filter(datetime < as_date("2018-07-8"))

g_out <- gather(out_plot, key = "type", value="radiation", -datetime) %>% filter(datetime < as_date("2018-07-8"))
```
```{r}
time_out %>%
  gather(key = "type", value = "radiation", sw_in, i_up, ic, ig, factor_key = T) %>%
  ggplot() +
  geom_line(aes(x = datetime, y = radiation, color = type)) +
  labs(title= "Time series shortwave variables", subtitle = "modelled output variables", y = "Shortwave radiation (W m-2)", colour = "") +
  scale_color_hue(labels = str_wrap(c("Incoming sw", "Upward sw", "Absorbed sw canopy", "Absorbed sw soil"), 10)) +
  theme(legend.key.height = unit(35, "pt"))
```
```{r}
time_out %>%
  gather(key = "type", value = "radiation", lw_in, l_up, lc, lg, factor_key = T) %>%
  ggplot() +
  geom_line(aes(x = datetime, y = radiation, color = type)) +
  labs(title= "Time series longwave variables", subtitle = "modelled output variables", y = "Longwave radiation (w m-2)", colour = "") +
  scale_color_hue(labels = str_wrap(c("Incoming lw", "Upward lw", "Absorbed lw canopy", "Absorbed lw soil"), 10)) +
  theme(legend.key.height = unit(35, "pt"))
```
## LAI over the year
```{r}
days <- seq.Date(as.Date("2020-01-01"), as.Date("2020-12-31"), by=1)
LAI <- pmax(Vectorize(get_day_LAI, "datetime")
            (days, pars$max_LAI, pars$leaf_out, pars$leaf_full, pars$leaf_fall, pars$leaf_fall_complete), pars$min_radiation_PAI)

ggplot() + geom_line(aes(x=days, y=LAI)) + ylim(c(0,pars$max_LAI)) + labs(title="LAI over the year")
```
# Test with sample
In this section we create some sample in put and we change only one variable to see how the model output respond to this

## Absorbed radiation vs LAI

The increase in LAI increase the amount of radiation absorbed, but then it reaches a peak at even if the LAI increase no more light is absorbed.
```{r}
fake_input_2 <- tibble(
    datetime = as.Date("2020-07-15 12:00"), # Summer day
    sw_in = 1000,
    sw_dif = 100,
    lw_in = 0,
    t_soil = 0,
    t_leaf = 0,
    LAI = 1:12,
    zenith = 30
)

out_2 <- cbind(rad_transf(input = fake_input_2), sw_in = fake_input_2$sw_in)
labels <-  str_wrap(c("Total incoming sw", "Total absorbed sw", "Absorbed sw sunlit canopy", "Absorbed sw shaded canopy"), 10)

out_2 %>%
        gather("type", "radiation", sw_in, ic, ic_sun, ic_sha, factor_key = T) %>%
        ggplot() +
        geom_line(aes(x=LAI, y=radiation, color=type, linetype=type)) +

        labs(title= "Absorbed sw with increasing LAI", subtitle = "Incoming radiation 900 direct + 100 diffuse. Zenith 30Â°",
             x="LAI (m2 m-2)", y="Absorbed shortwave radiation (W m-2)", color= "", linetype="") +
        scale_color_manual(values = c("black", hue_pal()(3)),labels = labels) +
        scale_linetype_manual(values = c(2,1,4,4), labels = labels) +
        theme(legend.key.height = unit(40, "pt"))

```

# Real data

```{r}
out <- rad_transf_new_p()

out_plot <- tibble(datetime = input$datetime, model_sw_out = out$i_up, observed_sw_out = fluxes$sw_out, model_lw_out = out$l_up, observed_lw_out = fluxes$lw_out)
```

scatter plot
```{r}
 g <- ggplot(data = out_plot) +
        geom_abline(aes(intercept = 0, slope = 1, color="theory"), linetype="dotted", key_glyph = "abline") +
        geom_point(aes(x=model_sw_out, y=observed_sw_out)) +
        geom_smooth(aes(x=model_sw_out, y=observed_sw_out, color="regression"), formula = y ~ x ,method='lm') +
        labs(title= "Time series shortwave variables", subtitle = "modelled output variables",
             x="Modelled emitted sw (W m-2)", y="Observed emitted sw (W m-2)", colour = "Legend") +
        scale_colour_manual(values = c(theory ="red", regression = "blue"),
                            guide = guide_legend(override.aes = list(linetype =c(1,2), size=c(0.5,0.5) )))
g
```

time series
```{r}
g_out %>%
  filter(type %in% c("model_sw_out", "observed_sw_out")) %>%
  ggplot() +
  geom_line(aes(x = datetime, y = radiation, color = type)) +
        labs(y="Outgoing shortwave radiation (w m-2)", colour = "")
        
```

### Longwave
scatter plot
```{r}
ggplot(data = out_plot) +
        geom_abline(intercept = 0, slope = 1, color="red", linetype="dotted") +
        geom_point(aes(x=model_lw_out, y=observed_lw_out)) +
        geom_smooth(aes(x=model_lw_out, y=observed_lw_out), method='lm') +
        labs(x="Modelled emitted lw (W m-2)", y="Observed emitted lw (W m-2)")
```
time series
```{r}
g_out %>%
  filter(type %in% c("model_lw_out", "observed_lw_out")) %>%
  ggplot() +
  geom_line(aes(x = datetime, y = radiation, color = type)) +
        labs(y="Outgoing longwave radiation (w m-2)", colour = "")
        # scale_x_datetime(breaks = breaks_12hours, labels = labels_12hours)
```

### Extra
LAI sunlit

```{r}
time_out %>%
  ggplot() +
  geom_line(aes(x = datetime, y = LAI_sunlit)) +
  geom_hline(yintercept = 5, linetype = "dotted")
  labs(y = "LAI sunlit (m2 m-2)")
```
```{r}
library(ggplot2)
colors <- c("Sepal Width" = "blue", "Petal Length" = "red", "Petal Width" = "orange")

ggplot(iris, aes(x = Sepal.Length)) +
    geom_line(aes(y = Sepal.Width, color = "Sepal Width"), size = 1.5) +
    geom_line(aes(y = Petal.Length, color = "Petal Length"), size = 1.5) +
    geom_line(aes(y = Petal.Width, color = "Petal Width"), size = 1.5) +
    labs(x = "Year",
         y = "(%)",
         color = "Legend") +
    scale_color_manual(values = colors)
```
```{r}

```
